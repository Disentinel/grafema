# T7.1: Migration Tool (Track 1, Rust)

> Milestone: M7 (Validation & Release)
> Dependencies: T4.1+
> Estimated: ~500 LOC, ~10 tests

---

## High-Level Context

Конвертация v1 database (nodes.bin + edges.bin + metadata.json) в v2 format (segments + manifests + shards). One-time migration для существующих пользователей.

---

## Design

### Migration Flow

1. Open v1 database files (nodes.bin, edges.bin, metadata.json)
2. Read all v1 NodeRecord/EdgeRecord from mmap'd segments
3. Convert to v2 format:
   - `semantic_id` from `metadata.originalId` (if present) or generate from legacy format
   - `content_hash = 0` (v1 doesn't have it)
   - Drop `exported`, `deleted`, `version` columns
   - Clean metadata: remove `originalId`, `_origSrc`, `_origDst`
4. Group nodes by file → shard plan
5. Write v2 segments per shard
6. Create manifest v1
7. Write current.json
8. Optionally: Semantic ID v2 conversion (v1 semantic → v2 semantic)

### Semantic ID Conversion

If migrating to Semantic ID v2 format (T1.4):
- Parse v1 semantic ID: `file->scope1->scope2->TYPE->name#N`
- Cannot reconstruct `namedParent` without AST → **full re-analysis required**
- Migration tool only converts storage format, not semantic IDs
- Semantic ID update happens when user runs `grafema analyze` after migration

### Progress Reporting

```rust
fn migrate(v1_path: &Path, v2_path: &Path, progress: impl Fn(MigrationProgress)) -> Result<()> {
    // Report: total nodes, nodes processed, percentage
}
```

---

## Test Plan

1. `migrate_empty_database` — empty v1 → empty v2
2. `migrate_with_data` — v1 with 1K nodes → v2, queryable
3. `migrate_preserves_data` — all nodes/edges roundtrip
4. `migrate_cleans_metadata` — no originalId in v2 metadata
5. `migrate_creates_manifest` — valid manifest after migration
6. `migrate_creates_shards` — nodes grouped into shards
7. `migrate_progress_reporting` — progress callback called
8. `migrate_idempotent` — run twice → same result
9. `migrate_invalid_v1` — corrupted v1 → clean error
10. `migrate_large` — 100K nodes → completes in reasonable time
