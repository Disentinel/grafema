# T6.2: Resource Adaptation (Track 1, Rust)

> Milestone: M6 (Performance)
> Dependencies: T6.1 (Compaction)
> Estimated: ~400 LOC, ~12 tests

---

## High-Level Context

RFDB должен адаптироваться к доступным ресурсам: на ноутбуке с 8GB RAM → маленькие buffers, частый flush. На сервере с 64GB → большие buffers, реже flush, больше параллелизма.

---

## Design

### ResourceManager

```rust
pub struct ResourceManager {
    total_memory: usize,
    available_memory: usize,
    cpu_cores: usize,
}

impl ResourceManager {
    pub fn detect() -> Self;

    pub fn write_buffer_size(&self) -> usize;      // Bytes before flush
    pub fn compaction_threads(&self) -> usize;       // Rayon thread pool size
    pub fn l0_threshold(&self) -> usize;             // Segments before compaction
    pub fn mmap_prefetch_size(&self) -> usize;       // Prefetch hint for mmap
}
```

### Adaptive Parameters

| Parameter | Low (512MB) | Medium (8GB) | High (64GB) |
|-----------|-------------|--------------|-------------|
| Write buffer | 1MB | 16MB | 128MB |
| Compaction threads | 1 | 2 | 4 |
| L0 threshold | 5 | 10 | 20 |
| mmap prefetch | 4KB | 64KB | 1MB |

### Memory Pressure Handling

Monitor RSS. If approaching limit:
1. Flush write buffers (free in-memory data)
2. Reduce buffer sizes for next cycle
3. Force compaction (reduce segment count → fewer mmap'd files)

---

## Test Plan

1. `low_memory_works` — 512MB constraint → correct, slower
2. `high_memory_faster` — 64GB → larger batches, fewer flushes
3. `no_oom` — enforce memory limits, degrade gracefully
4. `adaptive_parameters_correct` — detected resources → reasonable parameters
5. `memory_pressure_flush` — approaching limit → buffers flushed
6-12. Edge cases, parameter validation, monitoring
