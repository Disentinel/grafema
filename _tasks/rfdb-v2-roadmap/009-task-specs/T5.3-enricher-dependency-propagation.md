# T5.3: Enricher Dependency Propagation (Track 2, TS)

> Milestone: M5 (Enrichment Pipeline)
> Dependencies: T5.2 (Orchestrator Batch Protocol)
> Estimated: ~200 LOC, ~10 tests
> Related docs: [005-orchestrator-design.md](../005-orchestrator-design.md) §5, [T1.2 spec](./T1.2-enricher-contract-v2.md)

---

## High-Level Context

Когда enricher A изменяет свой output (новые/удалённые edges) → enrichers, зависящие от A's edge types, должны re-run. T5.3 формализует этот propagation pipeline.

---

## Design

### Propagation Rule

```
enricher A runs for file X → enricher_delta
If enricher_delta.changedEdgeTypes is non-empty:
  for each edge_type in changedEdgeTypes:
    downstream_enrichers = graph.getConsumers(edge_type)
    for each downstream:
      mark (downstream, X) as pending
```

### Work Queue

```typescript
class EnrichmentQueue {
  private pending: Map<string, Set<string>>;  // enricher → Set<file>

  enqueue(enricherName: string, file: string): void;
  dequeueNext(graph: EnricherDependencyGraph): { enricher: string; file: string } | null;
  isEmpty(): boolean;
}
```

Queue respects topological order: never dequeue enricher B before all enricher A (that B depends on) items are processed.

### Termination Proof

1. DAG: no cycles (guaranteed by Kahn's algorithm in T1.2)
2. Each enricher processes each file at most once per propagation wave
3. Propagation follows directed edges → bounded by graph depth × files
4. Worst case: all enrichers re-run for all affected files = v1 behavior

---

## Test Plan

1. `propagation_basic` — enricher A output changes → enricher B (consuming A) re-runs
2. `propagation_chain` — A → B → C chain, A changes → B and C re-run
3. `propagation_no_change` — enricher A output unchanged → downstream NOT triggered
4. `propagation_multiple_files` — A changes for file X → B runs for file X only
5. `termination_guaranteed` — complex dependency graph → propagation terminates
6. `worst_case_all_rerun` — propagation depth = full graph → same as v1 behavior
7. `no_cycles` — cyclic dependency detected → error at build time
8. `topological_order` — enrichers processed in dependency order
9. `independent_enrichers_parallel` — A and B at same level → can run in parallel
10. `queue_respects_dependencies` — B not dequeued before A completes
