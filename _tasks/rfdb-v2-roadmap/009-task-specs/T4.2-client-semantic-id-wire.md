# T4.2: Client Semantic ID Wire Format (Track 3, TS)

> Milestone: M4 (Integration Gate)
> Dependencies: T4.1 (Wire Protocol v3)
> Estimated: ~300 LOC, ~10 tests
> Related docs: [007-semantic-id-stability-research.md](../007-semantic-id-stability-research.md), [T1.4 spec](./T1.4-semantic-id-v2.md)

---

## High-Level Context

Убираем metadata hacks для semantic ID. В v1 semantic ID хранился в `metadata.originalId`, а edge src/dst в `metadata._origSrc`/`_origDst`. v2 делает semantic ID first-class field в wire protocol.

---

## Changes

### WireNodeV3

```typescript
interface WireNodeV3 {
  semanticId: string;     // NEW: first-class field
  id: string;             // u128 as hex string (for backward compat)
  nodeType: string;       // Required (was optional in v2)
  name?: string;
  file?: string;
  contentHash?: number;   // NEW: u64
  metadata?: string;      // JSON, NO originalId/_origSrc/_origDst
}
```

### WireEdgeV3

```typescript
interface WireEdgeV3 {
  src: string;            // semantic_id string (was u128 hex)
  dst: string;            // semantic_id string
  edgeType: string;       // Required
  metadata?: string;      // JSON
}
```

### Key Removals

- `metadata.originalId` → use `semanticId` field directly
- `metadata._origSrc` / `metadata._origDst` → use `src`/`dst` fields directly
- `mapNodeForWireFormat()` cleanup: no more metadata injection hacks

### RFDBServerBackend Cleanup

`packages/core/src/core/RFDBServerBackend.ts` currently adds `originalId` to metadata during addNode. This should be removed — server stores `semantic_id` as a column.

### Version Handshake

Client checks protocol version at connect time:
```typescript
const hello = await this.hello(3);
this.protocolVersion = hello.protocolVersion;
// Use WireNodeV3 format if protocolVersion >= 3
```

### Backward Compat

Client v3 connecting to server v2 (degraded mode):
- `semanticId` not available → fall back to `metadata.originalId`
- Log warning about degraded mode

---

## Test Plan

1. `semantic_id_roundtrip` — addNode with semanticId → getNode → same string
2. `no_metadata_hacks` — node metadata has NO originalId, _origSrc, _origDst
3. `edge_semantic_ids` — edge src/dst are semantic ID strings
4. `content_hash_roundtrip` — contentHash survives wire roundtrip
5. `version_handshake_v3` — hello → protocolVersion: 3
6. `backward_compat_v2_server` — client v3 + server v2 → degraded mode works
7. `all_existing_ts_tests_pass` — full TS test suite with v3 wire format
8. `rfdbs_backend_no_hacks` — RFDBServerBackend addNode → clean metadata
9. `query_returns_semantic_id` — queryNodes → results include semanticId
10. `node_type_required` — nodeType always present in response
