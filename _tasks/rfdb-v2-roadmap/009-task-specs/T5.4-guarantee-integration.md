# T5.4: Guarantee Integration (Track 2, TS)

> Milestone: M5 (Enrichment Pipeline)
> Dependencies: T5.2 (Orchestrator Batch Protocol)
> Estimated: ~200 LOC, ~12 tests
> Related docs: [005-orchestrator-design.md](../005-orchestrator-design.md) §3.4, [004-expert-concerns.md](../004-expert-concerns.md) C1/C2

---

## High-Level Context

Сейчас guarantees (Datalog rules) проверяются в VALIDATION фазе — **между analysis и enrichment**. Это ломает инварианты: guarantee может сработать на неполном графе (enrichment ещё не добавил edges).

**Решение (C1+C2):** Перенести guarantee checking на AFTER enrichment, как post-enrichment hook.

---

## Changes

### Move Guarantee Checking

```typescript
// Old pipeline:
// ANALYSIS → ENRICHMENT → VALIDATION (guarantees + issue reporting)

// New pipeline:
// ANALYSIS → ENRICHMENT → GUARANTEE CHECK → VALIDATION (issue reporting only)
```

### Selective Guarantee Checking

```typescript
// MVP: check ALL rules (5-20 rules, microseconds vs analysis time)
const allViolations = await graph.checkGuarantee(allRules);

// Optimization: only rules matching changedNodeTypes/changedEdgeTypes
const relevantRules = rules.filter(rule =>
  rule.relevantTypes.some(t =>
    delta.changedNodeTypes.includes(t) || delta.changedEdgeTypes.includes(t)
  )
);
```

### Coverage Monitoring (I4)

After enrichment, detect analyzer coverage gaps:
```typescript
for (const file of delta.changedFiles) {
  const contentChanged = delta.nodesModified;  // content_hash changed
  const analysisChanged = delta.nodesAdded + delta.nodesRemoved;

  if (contentChanged > 0 && analysisChanged === 0) {
    logger.warn(`Coverage gap: ${file} content changed but analysis identical`);
    // Future: create ISSUE nodes for coverage gaps
  }
}
```

---

## Critical Nuances

### 1. Guarantees Never Between Analysis and Enrichment

This is the key invariant. Orchestrator must enforce: no guarantee checks until ALL enrichers complete.

### 2. VALIDATION Phase = Issue Reporting Only

Remove guarantee checking from VALIDATION plugins. VALIDATION creates ISSUE nodes. Guarantees are checked separately.

### 3. content_hash = 0 Excluded

Nodes without content_hash (EXTERNAL_MODULE, etc.) excluded from coverage monitoring.

---

## Test Plan

1. `guarantees_after_enrichment` — guarantee rules only checked after all enrichers complete
2. `guarantee_not_during_enrichment` — guarantee NOT checked between enrichers
3. `selective_check_by_type` — change FUNCTION → only FUNCTION-related rules checked
4. `all_rules_checked_mvp` — without optimization → all rules checked (correct)
5. `coverage_gap_detected` — content changed + analysis same → warning logged
6. `coverage_gap_not_for_zero_hash` — content_hash=0 → no coverage warning
7. `existing_guarantee_tests_pass` — all existing guarantee tests work
8. `validation_creates_issues_only` — VALIDATION phase doesn't check guarantees
9. `guarantee_violations_collected` — violations aggregated in diagnostics
10. `guarantee_after_full_cycle` — analysis → enrichment → guarantees → correct graph state
11. `no_false_positives_during_enrichment` — incomplete graph during enrichment → no guarantees triggered
12. `coverage_canary_per_file` — coverage gap tracked per changed file
