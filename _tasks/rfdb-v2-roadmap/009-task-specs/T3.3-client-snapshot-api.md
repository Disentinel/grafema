# T3.3: Client Snapshot API (Track 3, TS)

> Milestone: M3 (Incremental Core)
> Dependencies: T2.1 (Rust Manifests), T3.1 (Rust Snapshots)
> Estimated: ~150 LOC, ~10 tests
> Related docs: [006-client-spec.md](../006-client-spec.md), [T2.1 spec](./T2.1-manifest-snapshot-chain.md)

---

## High-Level Context

T2.1 добавляет manifest chain + snapshots на стороне Rust. T3.3 — клиентский API для работы со снапшотами: tagging, поиск, diff.

Snapshot API нужен для:
- Пометить точку "до коммита" и "после коммита" → diff показывает что изменилось
- Найти snapshot по тегу (e.g., `{commit: "abc123"}`)
- Диагностика: "что изменилось между snapshot 5 и snapshot 10?"

---

## New Methods

### diffSnapshots()

```typescript
/**
 * Compute diff between two snapshots.
 * @param from - Snapshot reference (version number or {tag, value})
 * @param to - Snapshot reference
 */
async diffSnapshots(
  from: SnapshotRef,
  to: SnapshotRef
): Promise<SnapshotDiff> {
  const response = await this._send('diffSnapshots', {
    from: resolveRef(from),
    to: resolveRef(to),
  });
  return response as SnapshotDiff;
}
```

### tagSnapshot()

```typescript
/**
 * Add tags to a snapshot (manifest version).
 */
async tagSnapshot(
  version: number,
  tags: Record<string, string>
): Promise<void> {
  await this._send('tagSnapshot', { version, tags });
}
```

### findSnapshot()

```typescript
/**
 * Find snapshot by tag key/value.
 * Searches from current backward through chain.
 */
async findSnapshot(
  tagKey: string,
  tagValue: string
): Promise<number | null> {
  const response = await this._send('findSnapshot', { tagKey, tagValue });
  return response.version ?? null;
}
```

### listSnapshots()

```typescript
/**
 * List all snapshots with optional tag filter.
 */
async listSnapshots(filter?: string): Promise<SnapshotInfo[]> {
  const response = await this._send('listSnapshots', { filter });
  return response.snapshots as SnapshotInfo[];
}
```

---

## Types

```typescript
export type SnapshotRef =
  | number                               // Version number
  | { tag: string; value: string };      // Tag-based reference

export interface SnapshotDiff {
  fromVersion: number;
  toVersion: number;
  addedNodeSegments: SegmentInfo[];
  removedNodeSegments: SegmentInfo[];
  addedEdgeSegments: SegmentInfo[];
  removedEdgeSegments: SegmentInfo[];
  statsFrom: SnapshotStats;
  statsTo: SnapshotStats;
}

export interface SegmentInfo {
  segmentId: number;
  recordCount: number;
  byteSize: number;
  nodeTypes: string[];
  filePaths: string[];
  edgeTypes: string[];
}

export interface SnapshotStats {
  totalNodes: number;
  totalEdges: number;
  nodeSegmentCount: number;
  edgeSegmentCount: number;
}

export interface SnapshotInfo {
  version: number;
  createdAt: number;
  tags: Record<string, string>;
  stats: SnapshotStats;
}

function resolveRef(ref: SnapshotRef): Record<string, unknown> {
  if (typeof ref === 'number') {
    return { version: ref };
  }
  return { tagKey: ref.tag, tagValue: ref.value };
}
```

---

## Critical Nuances

### 1. SnapshotRef Resolution

Client sends either `{version: N}` or `{tagKey, tagValue}`. Server resolves tag to version internally. If tag not found → error.

### 2. Diff by Number vs Tag

```typescript
// These should produce identical results:
const diff1 = await client.diffSnapshots(5, 10);
const diff2 = await client.diffSnapshots(
  { tag: 'commit', value: 'abc' },  // resolves to 5
  { tag: 'commit', value: 'def' }   // resolves to 10
);
```

### 3. Wire Protocol Additions (Rust Side)

```rust
// New Request variants
DiffSnapshots { from: SnapshotRefWire, to: SnapshotRefWire },
TagSnapshot { version: u64, tags: HashMap<String, String> },
FindSnapshot { tag_key: String, tag_value: String },
ListSnapshots { filter: Option<String> },
```

These are trivial handlers — delegate to ManifestStore methods from T2.1.

---

## Test Plan

1. `tag_and_find` — tag snapshot → find by tag → correct version
2. `find_not_found` — search nonexistent tag → null
3. `diff_by_number` — diff(5, 10) → correct added/removed
4. `diff_by_tag` — diff by tag → same as diff by resolved version number
5. `diff_same_version` — diff(N, N) → empty diff
6. `list_snapshots` — list all → sorted by version, includes tags
7. `list_snapshots_filtered` — filter by tag key → correct subset
8. `tag_after_commit` — commitBatch → tag → find → correct
9. `snapshot_stats_correct` — stats match actual node/edge counts
10. `multiple_tags_on_snapshot` — tag with multiple k/v pairs → all retrievable
