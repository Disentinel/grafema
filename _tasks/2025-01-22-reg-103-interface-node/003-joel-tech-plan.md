# Joel Spolsky - Technical Implementation Plan: REG-103

## Scope

**Objective**: Migrate the last inline INTERFACE node creation in `GraphBuilder.bufferInterfaceNodes()` to use `InterfaceNode.create()` via NodeFactory pattern.

**What IS in scope**:
1. Replace inline object literal at GraphBuilder.ts:1064-1073 with `InterfaceNode.create()`
2. Update TypeScriptVisitor.ts:129 to generate ID with `:` separator (matching InterfaceNode.create format)
3. Update edge creation to use the new ID format consistently

**What is NOT in scope**:
- Adding `createWithContext()` to InterfaceNode (future REG-123 work)
- Changing InterfaceDeclarationInfo type structure
- Modifying other TypeScript node types (TYPE, ENUM, DECORATOR)

## ID Format Discrepancy - CRITICAL

**Current state**:
- TypeScriptVisitor generates: `INTERFACE#name#file#line` (line 129)
- InterfaceNode.create generates: `file:INTERFACE:name:line` (line 61)
- External interfaces already use NodeFactory format (`:` separator)

**Problem**: The inline creation at line 1064-1073 uses `iface.id` which has `#` separator, but edges to external interfaces (lines 1095-1107) use NodeFactory which generates `:` separator. This creates inconsistent IDs.

**Solution**: Follow established pattern (ClassNode migration). Let NodeFactory generate ID. Update TypeScriptVisitor to NOT pre-generate ID, or generate it in the correct format for consistency with EXTENDS edges.

**Decision**: Update TypeScriptVisitor to use `:` separator format, matching InterfaceNode.create(). This ensures:
1. Main interface nodes have correct format
2. EXTENDS edges point to IDs in the same format
3. External interfaces already use correct format

## Pre-Implementation

### Existing Tests

1. **InterfaceNode tests** in `test/unit/NodeFactoryPart2.test.js` (lines 481-842):
   - `InterfaceNode.create with isExternal` - 13 test cases
   - `NodeFactory.createInterface with isExternal` - 1 test case
   - ID consistency tests
   - Validation tests

2. **No tests use `INTERFACE#` format** - verified via grep

3. **Integration tests** - Need to check if any scenario tests analyze TypeScript files with interfaces

### Tests to Write BEFORE Implementation

**Test 1: InterfaceNode ID format consistency**
```typescript
// Verify InterfaceNode.create generates correct ID format
it('should generate ID with colon separator', () => {
  const node = InterfaceNode.create('IUser', '/src/types.ts', 5, 0);
  assert.strictEqual(node.id, '/src/types.ts:INTERFACE:IUser:5');
});
```

**Test 2: bufferInterfaceNodes creates valid nodes**
```typescript
// Integration test: TypeScript file with interface creates correct graph nodes
it('should create INTERFACE node with correct ID format', async () => {
  const code = `interface IUser { name: string; }`;
  const result = await analyzeTypeScript(code, '/src/types.ts');
  const interfaceNode = result.nodes.find(n => n.type === 'INTERFACE');
  assert.ok(interfaceNode.id.includes(':INTERFACE:'));
  assert.ok(!interfaceNode.id.includes('#'));
});
```

**Test 3: EXTENDS edge consistency**
```typescript
// Verify EXTENDS edges use consistent ID format
it('should create EXTENDS edge with matching ID formats', async () => {
  const code = `
    interface IBase { id: string; }
    interface IUser extends IBase { name: string; }
  `;
  const result = await analyzeTypeScript(code, '/src/types.ts');
  const extendsEdge = result.edges.find(e => e.type === 'EXTENDS');
  assert.ok(extendsEdge.src.includes(':INTERFACE:'));
  assert.ok(extendsEdge.dst.includes(':INTERFACE:'));
});
```

## Implementation Steps

### Step 1: Update TypeScriptVisitor ID generation

**File**: `/Users/vadimr/grafema/packages/core/src/plugins/analysis/ast/visitors/TypeScriptVisitor.ts`
**Line**: 129

**Change FROM**:
```typescript
const interfaceId = `INTERFACE#${interfaceName}#${module.file}#${node.loc!.start.line}`;
```

**Change TO**:
```typescript
const interfaceId = `${module.file}:INTERFACE:${interfaceName}:${node.loc!.start.line}`;
```

**Rationale**: Match InterfaceNode.create() format for consistency with external interfaces.

### Step 2: Replace inline creation with InterfaceNode.create()

**File**: `/Users/vadimr/grafema/packages/core/src/plugins/analysis/ast/GraphBuilder.ts`
**Lines**: 1064-1073

**Change FROM**:
```typescript
this._bufferNode({
  id: iface.id,
  type: 'INTERFACE',
  name: iface.name,
  file: iface.file,
  line: iface.line,
  column: iface.column,
  properties: iface.properties,
  extends: iface.extends
});
```

**Change TO**:
```typescript
const interfaceNode = InterfaceNode.create(
  iface.name,
  iface.file,
  iface.line,
  iface.column,
  {
    extends: iface.extends,
    properties: iface.properties
  }
);
this._bufferNode(interfaceNode as unknown as GraphNode);
```

**Note**: The ID is now generated by InterfaceNode.create(), not taken from `iface.id`. This is intentional - NodeFactory should own ID generation.

### Step 3: Update edges to use InterfaceNode-generated ID

**File**: `/Users/vadimr/grafema/packages/core/src/plugins/analysis/ast/GraphBuilder.ts`
**Lines**: 1076-1080 (CONTAINS edge)

**Change FROM**:
```typescript
this._bufferEdge({
  type: 'CONTAINS',
  src: module.id,
  dst: iface.id
});
```

**Change TO**:
```typescript
this._bufferEdge({
  type: 'CONTAINS',
  src: module.id,
  dst: interfaceNode.id
});
```

### Step 4: Update EXTENDS edge for same-file interfaces

**File**: `/Users/vadimr/grafema/packages/core/src/plugins/analysis/ast/GraphBuilder.ts`
**Lines**: 1088-1092

**Problem**: The current code uses `iface.id` and `parentInterface.id` which are pre-generated IDs from TypeScriptVisitor.

**Solution**: After Step 1 (updating TypeScriptVisitor), the IDs in InterfaceDeclarationInfo will already be in correct format. However, we should use the node ID from the created InterfaceNode for consistency.

**Approach**: Store created interface nodes in a map for edge creation:

```typescript
private bufferInterfaceNodes(module: ModuleNode, interfaces: InterfaceDeclarationInfo[]): void {
  // First pass: create all interface nodes and store them
  const interfaceNodes = new Map<string, InterfaceNodeRecord>();

  for (const iface of interfaces) {
    const interfaceNode = InterfaceNode.create(
      iface.name,
      iface.file,
      iface.line,
      iface.column,
      {
        extends: iface.extends,
        properties: iface.properties
      }
    );
    interfaceNodes.set(iface.name, interfaceNode);
    this._bufferNode(interfaceNode as unknown as GraphNode);

    // MODULE -> CONTAINS -> INTERFACE
    this._bufferEdge({
      type: 'CONTAINS',
      src: module.id,
      dst: interfaceNode.id
    });
  }

  // Second pass: create EXTENDS edges
  for (const iface of interfaces) {
    if (iface.extends && iface.extends.length > 0) {
      const srcNode = interfaceNodes.get(iface.name)!;

      for (const parentName of iface.extends) {
        const parentNode = interfaceNodes.get(parentName);

        if (parentNode) {
          // Same-file interface
          this._bufferEdge({
            type: 'EXTENDS',
            src: srcNode.id,
            dst: parentNode.id
          });
        } else {
          // External interface
          const externalInterface = NodeFactory.createInterface(
            parentName,
            iface.file,
            iface.line,
            0,
            { isExternal: true }
          );
          this._bufferNode(externalInterface as unknown as GraphNode);
          this._bufferEdge({
            type: 'EXTENDS',
            src: srcNode.id,
            dst: externalInterface.id
          });
        }
      }
    }
  }
}
```

### Step 5: Add import for InterfaceNode

**File**: `/Users/vadimr/grafema/packages/core/src/plugins/analysis/ast/GraphBuilder.ts`

Add to imports (near line 15-30):
```typescript
import { InterfaceNode } from '../../../core/nodes/InterfaceNode.js';
```

Or if using index:
```typescript
import { InterfaceNode } from '../../../core/nodes/index.js';
```

Check existing pattern in the file.

## Testing

### Run existing tests first
```bash
node --test test/unit/NodeFactoryPart2.test.js
```

### Run TypeScript-specific scenario tests
```bash
node --test test/scenarios/*.test.js
```

### Create new test file (if needed)
**File**: `test/unit/InterfaceNodeMigration.test.js`

Test cases:
1. InterfaceNode.create generates correct ID format
2. bufferInterfaceNodes creates nodes with correct ID
3. CONTAINS edges use InterfaceNode-generated ID
4. EXTENDS edges between same-file interfaces use correct IDs
5. EXTENDS edges to external interfaces use correct IDs

### Verify build
```bash
npm run build
```

## Files Modified

1. `/Users/vadimr/grafema/packages/core/src/plugins/analysis/ast/visitors/TypeScriptVisitor.ts`
   - Line 129: Update ID format from `#` to `:` separator

2. `/Users/vadimr/grafema/packages/core/src/plugins/analysis/ast/GraphBuilder.ts`
   - Lines 1064-1111: Replace inline creation and refactor bufferInterfaceNodes()
   - Add import for InterfaceNode

3. `test/unit/InterfaceNodeMigration.test.js` (new file)
   - Tests for migration verification

## Rollback Plan

If something goes wrong:

1. **Git reset**: All changes are in 2 files + 1 new test file
   ```bash
   git checkout packages/core/src/plugins/analysis/ast/visitors/TypeScriptVisitor.ts
   git checkout packages/core/src/plugins/analysis/ast/GraphBuilder.ts
   rm test/unit/InterfaceNodeMigration.test.js
   ```

2. **No database migration**: This only changes node ID format in memory/graph storage

3. **Breaking change consideration**: If existing graphs have INTERFACE nodes with `#` separator:
   - Re-analysis will create new nodes with `:` separator
   - Old nodes won't match new format
   - Solution: `grafema analyze --clear` to rebuild graph

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| ID format change breaks existing queries | Medium | Tests verify format; --clear flag available |
| EXTENDS edges don't match | High | Two-pass approach ensures consistency |
| Import statement location | Low | Follow existing patterns in file |
| Type cast `as unknown as GraphNode` | Low | Same pattern used for external interfaces |

## Estimated Time

- Tests: 30 minutes
- Implementation: 45 minutes
- Verification: 30 minutes
- **Total**: ~2 hours

## Success Criteria

1. No inline object literal creation for INTERFACE nodes in GraphBuilder
2. All INTERFACE node IDs use format: `{file}:INTERFACE:{name}:{line}`
3. EXTENDS edges connect nodes with matching ID formats
4. All existing tests pass
5. New migration tests pass
6. `npm run build` succeeds
