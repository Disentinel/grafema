# Infrastructure Gap: GAP-001 — CONFIRMED BUG

**Verdict:** confirmed bug (WebSocket transport missing `openDatabase()`)
**Panel:** ALL (affects every panel)
**Status:** confirmed — blocking QA

## Description

The Grafema VS Code extension connects to rfdb-server via WebSocket (Status panel shows "Connected") but ALL graph queries fail with:

```
findNodeAtCursor error: No database selected. Use openDatabase first.
```

## Root Cause (confirmed 2026-02-20)

**The extension never calls `openDatabase()` when using WebSocket transport.**

### Protocol v1 vs v2 behavior

rfdb-server has two connection paths:

| Transport | Protocol | Auto-open "default" DB? |
|-----------|----------|------------------------|
| Unix socket | v1 (legacy) | **YES** — `handle_client_unix()` auto-opens "default" DB for legacy clients |
| WebSocket | v2 | **NO** — client MUST call `hello()` + `openDatabase("default")` |

### Extension connect flow (`grafemaClient.ts`)

```
connect() →
  if transport === 'websocket':
    new RFDBWebSocketClient(wsUrl)
    await wsClient.connect()
    await wsClient.ping()          ← verifies connection
    this.client = wsClient
    // MISSING: await wsClient.hello()
    // MISSING: await wsClient.openDatabase("default")
  else:
    // Unix socket mode — works because server auto-opens DB in legacy mode
```

### Docker demo settings (`.vscode/settings.json`)

```json
{
  "grafema.rfdbTransport": "websocket",
  "grafema.rfdbWebSocketUrl": "ws://localhost:7432"
}
```

### Server code evidence

**Unix socket — has auto-open** (`rfdb_server.rs:2103-2111`):
```rust
let mut session = ClientSession::new(client_id);
if legacy_mode {
    if let Ok(db) = manager.get_database("default") {
        db.add_connection();
        session.set_database(db, AccessMode::ReadWrite);
    }
}
```

**WebSocket — NO auto-open** (`rfdb_server.rs:2209-2228`):
```rust
let mut session = Some(ClientSession::new(client_id));
// WebSocket clients MUST send Hello first (no legacy mode)
```

**Error source** (`rfdb_server.rs:1712-1715`):
```rust
fn with_engine_read<F>(session: &ClientSession, f: F) -> Response {
    match &session.current_db {
        Some(db) => { /* ... */ },
        None => Response::ErrorWithCode {
            error: "No database selected. Use openDatabase first.".to_string(),
            code: "NO_DATABASE_SELECTED".to_string(),
        },
    }
}
```

## Verification

Waited 80 seconds with exponential backoff (5+10+15+20+30s). Error persists at every attempt. This is NOT a timing issue.

Screenshots: `_qa/screenshots/ready-attempt-{1..5}.png` — all identical: Status "Connected", all panels placeholder, Debug Log shows same error.

## Fix Options

**Option A — Extension fix (proper):** In `grafemaClient.ts`, after WebSocket connect + ping, call:
```typescript
await wsClient.hello({ protocolVersion: 2 });
await wsClient.openDatabase("default");
```

**Option B — Server fix:** Add legacy auto-open for WebSocket clients too (mirrors unix socket behavior).

**Option C — Docker workaround:** Switch demo to unix socket transport (changes `.vscode/settings.json` to use `unix` transport + socket path).

Recommended: **Option A** — makes the extension a proper protocol v2 client.

## Timeline

| Date | Event |
|------|-------|
| 2026-02-20 12:55 | Found: all panels show placeholder, Debug Log error |
| 2026-02-20 13:20 | Misclassified as timing issue |
| 2026-02-20 ~14:00 | Verification: waited 80s, error persists — NOT timing |
| 2026-02-20 ~14:00 | Root cause found: WebSocket transport missing openDatabase() |

## Affected Files

- `packages/vscode/src/grafemaClient.ts` — missing `hello()` + `openDatabase()` calls
- `packages/rfdb-server/src/bin/rfdb_server.rs` — WebSocket handler lacks legacy auto-open
- ALL QA files blocked until fix is applied

## Linear Issue

[REG-528](https://linear.app/reginaflow/issue/REG-528/extension-ne-vybiraet-bazu-dannyh-avtomaticheski-vse-paneli)
