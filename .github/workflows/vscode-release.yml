# Build and publish platform-specific VS Code extension packages
#
# Triggered by: git tag vscode-vX.Y.Z && git push --tags
# Outputs: GitHub Release with platform-specific VSIXs
#
# Prerequisites:
#   - rfdb-server binaries must exist in a GitHub Release (from build-binaries.yml)
#
# Platforms:
#   - darwin-arm64: macOS Apple Silicon
#   - darwin-x64:   macOS Intel
#   - linux-x64:    Linux x64
#   - linux-arm64:  Linux ARM64

name: VS Code Extension Release

on:
  push:
    tags:
      - 'vscode-v*'
  workflow_dispatch:
    inputs:
      rfdb_version:
        description: 'RFDB version tag to use (e.g., rfdb-v0.1.0). Leave empty to use latest.'
        required: false
        type: string

permissions:
  contents: write

env:
  NODE_VERSION: '20'
  # Pin rfdb-server version for API compatibility
  # Update this when releasing new extension version with updated rfdb dependency
  RFDB_VERSION: 'rfdb-v0.2.1-beta'

jobs:
  # Build platform-specific VSIXs
  build:
    name: Package ${{ matrix.platform }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: darwin-arm64
            binary_name: rfdb-server-darwin-arm64
          - platform: darwin-x64
            binary_name: rfdb-server-darwin-x64
          - platform: linux-x64
            binary_name: rfdb-server-linux-x64
          - platform: linux-arm64
            binary_name: rfdb-server-linux-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        working-directory: packages/vscode
        run: pnpm install

      - name: Build extension
        working-directory: packages/vscode
        run: pnpm run build

      - name: Download rfdb-server binary
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Use workflow_dispatch input if provided, otherwise use pinned version
          RFDB_TAG="${{ inputs.rfdb_version }}"
          if [ -z "$RFDB_TAG" ]; then
            RFDB_TAG="${{ env.RFDB_VERSION }}"
          fi
          echo "Using rfdb-server version: $RFDB_TAG"

          mkdir -p packages/vscode/binaries
          gh release download "$RFDB_TAG" \
            --pattern "${{ matrix.binary_name }}" \
            --dir packages/vscode/binaries
          # Rename to standard name (remove platform suffix)
          mv packages/vscode/binaries/${{ matrix.binary_name }} packages/vscode/binaries/rfdb-server
          chmod +x packages/vscode/binaries/rfdb-server
          ls -lh packages/vscode/binaries/

      - name: Verify binary
        run: |
          file packages/vscode/binaries/rfdb-server
          du -h packages/vscode/binaries/rfdb-server

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Package VSIX
        working-directory: packages/vscode
        run: |
          vsce package --target ${{ matrix.platform }} --no-dependencies
          ls -lh *.vsix

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: vsix-${{ matrix.platform }}
          path: packages/vscode/*.vsix

  # Create GitHub release with all VSIXs
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all VSIXs
        uses: actions/download-artifact@v4
        with:
          pattern: vsix-*
          merge-multiple: true
          path: vsix/

      - name: List VSIXs
        run: ls -lh vsix/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: vsix/*.vsix
          fail_on_unmatched_files: true
          body: |
            ## VS Code Extension Release

            Platform-specific packages for Grafema Explore VS Code extension.

            **Bundled rfdb-server version:** `${{ env.RFDB_VERSION }}`

            ### Installation

            1. Download the VSIX for your platform
            2. In VS Code: Extensions > ... > Install from VSIX
            3. Select the downloaded file

            ### Platforms

            | File | Platform |
            |------|----------|
            | `grafema-explore-*-darwin-arm64.vsix` | macOS Apple Silicon |
            | `grafema-explore-*-darwin-x64.vsix` | macOS Intel |
            | `grafema-explore-*-linux-x64.vsix` | Linux x64 |
            | `grafema-explore-*-linux-arm64.vsix` | Linux ARM64 |
