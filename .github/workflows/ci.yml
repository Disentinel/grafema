# Continuous Integration for Grafema
#
# Runs on:
#   - Every push to main and stable
#   - Every pull request to main
#
# Validates:
#   - All tests pass (no .skip or .only)
#   - TypeScript compiles
#   - ESLint passes
#   - All packages build
#   - Package versions are in sync

name: CI

on:
  push:
    branches: [main, stable]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '22'
  # Each self-hosted runner needs its own pnpm store to avoid reflink conflicts
  PNPM_STORE_DIR: ${{ github.workspace }}/.pnpm-store
  # Limit Cargo parallelism â€” 4 concurrent runners sharing one machine
  CARGO_BUILD_JOBS: '2'

jobs:
  # Job 1: Run all tests
  test:
    name: Tests
    runs-on: self-hosted
    timeout-minutes: 10

    steps:
      - name: Raise file descriptor limit
        run: ulimit -n 65536

      - name: Clean workspace
        run: rm -rf node_modules .pnpm-store .pnpm-home

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: true

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          dest: ${{ github.workspace }}/.pnpm-home

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: ulimit -n 65536 && pnpm install --frozen-lockfile

      - name: Build (required for tests)
        run: pnpm build

      - name: Run tests with coverage
        run: |
          set -o pipefail
          pnpm test:coverage 2>&1 | tee /tmp/pnpm-test-coverage.log

      - name: Summarize failed tests
        if: failure()
        run: |
          echo "### Failed tests (excluding TODO)" >> "$GITHUB_STEP_SUMMARY"
          if grep -E "not ok" /tmp/pnpm-test-coverage.log | grep -v "# TODO" > /tmp/pnpm-test-failures.log; then
            cat /tmp/pnpm-test-failures.log >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No non-TODO failing 'not ok' lines found in TAP output." >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### TAP summary" >> "$GITHUB_STEP_SUMMARY"
          grep -E "# tests|# pass|# fail|# todo" /tmp/pnpm-test-coverage.log >> "$GITHUB_STEP_SUMMARY" || true

      - name: Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-log
          path: /tmp/pnpm-test-coverage.log
          retention-days: 14

      - name: Extract coverage percentage
        if: github.ref == 'refs/heads/main'
        id: coverage
        run: |
          COVERAGE=$(node -e "
            const r = JSON.parse(require('fs').readFileSync('coverage/coverage-final.json','utf8'));
            let hit=0, total=0;
            for (const f of Object.values(r)) {
              for (const [,c] of Object.entries(f.s)) { total++; if(c>0) hit++; }
            }
            console.log(total>0 ? Math.round(hit/total*100) : 0);
          ")
          echo "pct=$COVERAGE" >> "$GITHUB_OUTPUT"
          echo "Coverage: ${COVERAGE}%"

      - name: Update coverage badge
        if: github.ref == 'refs/heads/main' && vars.COVERAGE_GIST_ID != ''
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: ${{ vars.COVERAGE_GIST_ID }}
          filename: grafema-coverage.json
          label: coverage
          message: ${{ steps.coverage.outputs.pct }}%
          valColorRange: ${{ steps.coverage.outputs.pct }}
          minColorRange: 0
          maxColorRange: 100

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/lcov-report/
          retention-days: 14

      - name: Check for .only in test files
        run: |
          echo "Checking for .only() in test files..."
          if grep -rE '\.only\s*\(' test/ --include="*.test.js" --include="*.test.ts" 2>/dev/null; then
            echo "::error::Found .only() in test files. Remove before merging."
            exit 1
          fi
          echo "No .only() found."

      - name: Check for .skip in test files (stable only)
        if: github.ref == 'refs/heads/stable'
        run: |
          echo "Checking for .skip() in test files (stable branch)..."
          if grep -rE '\.skip\s*\(' test/ --include="*.test.js" --include="*.test.ts" 2>/dev/null; then
            echo "::error::Found .skip() in test files. All tests must pass on stable."
            exit 1
          fi
          echo "No .skip() found."

  # Job 2: TypeScript and ESLint
  typecheck-lint:
    name: Typecheck & Lint
    runs-on: self-hosted
    timeout-minutes: 10

    steps:
      - name: Raise file descriptor limit
        run: ulimit -n 65536

      - name: Clean workspace
        run: rm -rf node_modules .pnpm-store .pnpm-home

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: true

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          dest: ${{ github.workspace }}/.pnpm-home

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: ulimit -n 65536 && pnpm install --frozen-lockfile

      - name: Build all packages (required for cross-package typecheck)
        run: pnpm build

      - name: TypeScript check
        run: pnpm typecheck

      - name: ESLint
        run: pnpm lint

  # Job 3: Build all packages
  build:
    name: Build
    runs-on: self-hosted
    timeout-minutes: 10

    steps:
      - name: Raise file descriptor limit
        run: ulimit -n 65536

      - name: Clean workspace
        run: rm -rf node_modules .pnpm-store .pnpm-home

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: true

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          dest: ${{ github.workspace }}/.pnpm-home

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: ulimit -n 65536 && pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Verify build artifacts exist
        run: |
          echo "Verifying build outputs..."
          # Check that dist directories exist for key packages
          test -d packages/types/dist || (echo "::error::packages/types/dist not found" && exit 1)
          test -d packages/core/dist || (echo "::error::packages/core/dist not found" && exit 1)
          test -d packages/cli/dist || (echo "::error::packages/cli/dist not found" && exit 1)
          test -d packages/mcp/dist || (echo "::error::packages/mcp/dist not found" && exit 1)
          echo "All build artifacts verified."

  # Job 4: Version sync check
  version-sync:
    name: Version Sync
    runs-on: self-hosted
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check all package versions match
        run: |
          echo "Checking package version synchronization..."

          # Get root version
          ROOT_VERSION=$(node -p "require('./package.json').version")
          echo "Root version: $ROOT_VERSION"

          # Check all publishable packages
          PACKAGES=(
            "packages/types"
            "packages/core"
            "packages/cli"
            "packages/mcp"
            "packages/api"
            "packages/rfdb"
            "packages/rfdb-server"
          )

          MISMATCH=0
          for pkg in "${PACKAGES[@]}"; do
            if [ -f "$pkg/package.json" ]; then
              PKG_VERSION=$(node -p "require('./$pkg/package.json').version")
              PKG_NAME=$(node -p "require('./$pkg/package.json').name")
              if [ "$PKG_VERSION" != "$ROOT_VERSION" ]; then
                echo "::error::Version mismatch: $PKG_NAME is $PKG_VERSION, expected $ROOT_VERSION"
                MISMATCH=1
              else
                echo "  $PKG_NAME: $PKG_VERSION"
              fi
            fi
          done

          if [ "$MISMATCH" -eq 1 ]; then
            echo ""
            echo "::error::Package versions are out of sync. Run: pnpm -r exec npm version $ROOT_VERSION --no-git-tag-version --allow-same-version"
            exit 1
          fi

          echo "All package versions are in sync."
